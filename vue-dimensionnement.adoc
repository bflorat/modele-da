# Vue dimensionnement
:sectnumlevels: 4
:toclevels: 4
:sectnums: 4
:toc: left
:icons: font
:toc-title: Sommaire

*Derni√®re modification* : {docdate} 

*Date de la derni√®re revue globale* :  _<Faire r√©guli√®rement des revues compl√®tes de la vue (au moins une fois par an tant que le projet est actif) et mentionner la date ici>_

*Statut du document* :  _<Indiquer ici le statut de la vue, par exemple 'DRAFT', 'FINALIS√â',...>_

//üè∑{"id": "32c8942e-443f-429d-a411-43869a720224", "labels": ["context"]}
## Introduction

La vue dimensionnement permet de d√©terminer la taille de l'infrastructure n√©cessaire au projet.

Les autres vues du dossier sont accessibles link:./README.adoc[d'ici].

Le glossaire du projet est disponible link:glossaire.adoc[ici]. Nous ne reprendrons pas ici les termes fonctionnels ou techniques d√©j√† d√©finis.

//üè∑{"id": "c443e562-398d-49ab-92bd-8031f3e91bec", "labels": ["context","references"]}
### Documentation de R√©f√©rence

.R√©f√©rences documentaires dimensionnement
[cols="1e,1e,4e,4e"]
|===
|N¬∞|Version|Titre/URL du document|D√©tail

|1|1.2|Rapport_benchmark_xyz.pdf|
|2|2019|Rapport de l'INSEE sur les entreprises fran√ßaises|


|===

//üè∑{"id": "1ef7beb9-71ee-43e5-9a1b-c45a48959084", "labels": ["context","uncertainty"]}
## Non statu√©

//üè∑{"id": "c5db3e60-e70c-4ebb-9848-44a0cecc4c6e", "labels": []}
### Points n√©cessitant une √©tude compl√©mentaire

.Points n√©cessitant une √©tude compl√©mentaire
[cols="1e,1e,1e,2e,2e"]
|===
|ID| D√©tail |Statut |Porteur du sujet  | √âch√©ance

|1| Capacit√© disques SSD |EN_COURS | XYZ | 01/01/2022

|===

//üè∑{"id": "577c9b37-77a2-4568-9fb5-2804d6f9bc70", "labels": []}
### Hypoth√®ses

[TIP]
====
Fournir ici les hypoth√®ses structurantes prises pour le dimensionnement
====

====
Exemple: 

.Hypoth√®ses
[cols="1e,4e"]
|===
|ID|D√©tail

|1|Nous estimons que 10 millions de personnes t√©l√©chargeront l'application XYZ

|===

====

//üè∑{"id": "69811b17-b947-4562-90ba-a97160421965", "labels": ["detail_level::overview", "constraints"]}
## Contraintes

[TIP]
====
Les contraintes d√©finissent les limites applicables aux exigences du projet.

Il est important de les expliciter pour obtenir des exigences r√©alistes. Par exemple, il ne serait pas r√©aliste d'exiger des temps de r√©ponse d'un web service incompatibles avec le d√©bit du r√©seau sous-jacent.

====

//üè∑{"id": "646fc728-6cef-4e75-9fa9-646b4ec2159d", "labels": []}
### Contraintes stockage

TIP: Lister ici les √©ventuelles contraintes li√©es au stockage persistant.

[Exemple]
====
Exemple : L'espace disque maximal allouable √† une VM est de 2 To.
====

//üè∑{"id": "1d3ec06e-d63d-4a61-bb4e-437358064687", "labels": ["niveau::interm√©daire", "niveau_detail::detaill√©"]}
### Contraintes CPU

TIP: Lister ici les √©ventuelles contraintes li√©es √† la puissance de calcul
[Exemple]
====
Exemple 1 : Une VM sera dot√©e au maximum de 10 VCPU
====

====
Exemple 2 : L'ensemble des pods de l'application ne devra pas demander plus de 1 CPU par node.
====

//üè∑{"id": "ec6a420b-c284-442a-93fd-edc3d45ed00a", "labels": ["niveau::interm√©daire", "niveau_detail::detaill√©"]}
### Contraintes m√©moire

TIP: Lister ici les √©ventuelles contraintes li√©es √† la m√©moire
[Exemple]
====
Exemple : un pod ou un job Kubernetes ne devra pas utiliser plus de 6 Go de RAM
====

//üè∑{"id": "8d948872-15f9-49b6-9527-f511a2f7597d", "labels": []}
### Contraintes r√©seau

TIP: Lister ici les √©ventuelles contraintes de volume r√©seau utilis√©
[Exemple]
====
Exemple 1 : La latence minimale des requ√™tes sur le WAN entre Londres et Tokyo est de 250 ms
====

[Exemple]
====
Exemple 2 : Le c≈ìur de r√©seau du datacenter dispose d'une bande passante de 40 Gbps.
====

//üè∑{"id": "d6e3eb12-371b-4c26-b538-9fea2051bfed", "labels": ["detail_level::overview", "requirement"]}
## Exigences

[TIP]
====
Il est crucial de privil√©gier les donn√©es issues de la production plut√¥t que des estimations, car ces derni√®res sont souvent √©loign√©es de la r√©alit√©. C'est d'autant plus difficile s'il s'agit d'un nouveau projet. Il est alors recommand√© de pr√©voir une marge importante. Les informations donn√©es ici pourront servir d'entrants au SLO (objectif de niveau de service fix√© par les exploitants).
====

[TIP]
====
Les sections suivantes portant sur les calculs de volum√©trie statiques et dynamiques donnent des exemples de calculs et d'√©l√©ments √† prendre en compte. Sur le plan de la forme, il peut √™tre pr√©f√©rable de remplacer le texte par des feuilles de calculs dans un tableur. Pour un projet complexe ou aux hypoth√®ses mouvantes, c'est indispensable.

====

//üè∑{"id": "962347a4-c3c8-4f0c-bcac-774a6ef617a4", "labels": []}
### Volum√©trie statique

TIP: Il s'agit des m√©triques permettant de d√©terminer le volume de stockage *cumul√©* du projet. Penser √† bien pr√©ciser les hypoth√®ses prises pour les m√©triques estim√©es. Il sera ainsi possible de les revoir si de nouveaux √©l√©ments m√©tier apparaissent.

//üè∑{"id": "1736e661-2c68-4aa6-a157-9e4444d5a374", "labels": ["niveau_detail::detaill√©"]}
#### M√©triques

TIP: Il s'agit des donn√©es m√©tier mesur√©es ou estim√©es qui serviront d'entrants au calcul des besoins techniques de stockage.

[cols="e,e,e,e,e,e,e"]
|===
|M√©trique|Description |Mesur√©e ou Estim√©e ? | Valeur | Augmentation annuelle pr√©visionnelle (%) |  Source| D√©tail/hypoth√®ses

|S1 |Nombre d'entreprises √©ligibles | Estim√© |  4M | +1% |  INSEE [2]  | On consid√®re que MIEL ne concerne pas les auto-entrepreneurs
|S2 |Taille moyenne d'un PDF compos√©| Mesur√©e | 40Ko  | 0%| Exploitants | 
|===

//üè∑{"id": "9968c2e6-46b9-4005-89d4-6a9114246a4c", "labels": ["niveau_detail::detaill√©"]}
#### Estimation besoins de stockage

[TIP]
====
Lister ici les besoins en stockage de chaque module une fois l‚Äôapplication arriv√©e √† pleine charge (volum√©trie √† deux ans par exemple).

Prendre en compte :

* La taille des bases de donn√©es.
* La taille des fichiers produits.
* La taille des files.
* La taille des journaux.
* L'espace n√©cessaire dans un √©ventuel stockage objet (S3, Swift, Ceph‚Ä¶)
*  ‚Ä¶

Ne pas prendre en compte :

* Le volume li√© √† la sauvegarde : elle est g√©r√©e par les exploitants.
* Le volume des binaires (OS, intergiciels‚Ä¶) qui est √† consid√©rer par les exploitants comme une volum√©trie de base d'un serveur (le ticket d'entr√©e) et qui est de leur ressort.
* Les donn√©es archiv√©es qui ne sont donc plus en ligne.

Fournir √©galement une estimation de l'augmentation annuelle en pourcentage du volume pour permettre aux exploitants de commander ou r√©server suffisamment de disque.

Pour les calculs de volum√©trie, penser √† prendre en compte les sp√©cificit√©s de l'encodage (nombre d‚Äôoctets par caract√®re, par date, par valeur num√©rique‚Ä¶). 

Pour une base de donn√©es, pr√©voir l'espace occup√© par les index, qui varie selon l'application et le moteur de base de donn√©es. Une estimation pr√©liminaire peut consister √† ajouter environ 30 % d'espace disque suppl√©mentaire, √† affiner selon les tests.

Ne prendre en compte que les donn√©es dont la taille est significative (au moins quelques Gio).
====

====
. Exemple de volum√©trie statique du module C :
|===
|Donn√©e|Description|Taille unitaire|Nombre d'√©l√©ments √† 2 ans|Taille totale|Augmentation annuelle

|Table Article
|Les articles du catalogue
|2Kio
|100K
|200 Mio
|5 %

|Table Commande
|Les commandes clients
|10Ko
|3M
|26.6 Gio
|10 %

|Logs 
|Les journaux applicatifs (niveau INFO)
|200 o
|300M
|56 Gio
|0 % (archivage)
|===
====

//üè∑{"id": "b22cadba-e5a7-4c3a-b4b8-f9ea32a2a0be", "labels": []}
### Volum√©trie dynamique

TIP: Il s'agit des m√©triques par dur√©e (ann√©e, mois, heure‚Ä¶) et permettant de d√©terminer la charge appliqu√©e sur l'architecture, ce qui aidera √† dimensionner les syst√®mes en terme de CPU, bande passante et performances des disques.  

//üè∑{"id": "910fc171-30ed-47cd-b03c-3ca918b3103e", "labels": ["niveau_detail::detaill√©"]}
#### M√©triques

TIP: Ce sont les donn√©es m√©tier mesur√©es ou estim√©es qui serviront d'entrants au calcul de la charge.

[cols="e,e,e,e,e,e,e,e"]
|===
|M√©trique|Description |Mesur√©e ou Estim√©e ? | Valeur | Augmentation annuelle pr√©visionnelle (%) | Saisonnalit√©|  Source| D√©tail/hypoth√®ses 

|D1 |Proportion d'utilisateurs se connectant au service / J | Estim√©e | 1%  | +5%  
a| 

 - Constant sur l'ann√©e
 - Constant sur la semaine
 - 3 pics √† 20% de la journ√©e √† 8:00-9:00, 11:00-12:00 et 14:00-15:00
 | Service communication, rapport du 01/01/2040
 | Les utilisateurs sont des professionnels utilisant l'application depuis la France m√©tropolitaine aux heures de bureau standards
|===

//üè∑{"id": "3d09511c-17b2-43c3-bcba-0a62ead057b4", "labels": ["niveau_detail::detaill√©"]}
#### Estimation de la charge

[TIP]
====
Il s'agit ici d'estimer le nombre d'appels aux modules et donc le d√©bit cible (en TPS = Transactions par seconde) que chacun d'entre eux devra absorber. Un syst√®me bien dimensionn√© devra pr√©senter des temps de r√©ponse moyen du m√™me ordre en charge nominale et en pic.

Estimer le "pic du pic", c'est-√†-dire le moment o√π la charge sera maximale suite au cumul de tous les facteurs (par exemple pour un syst√®me de comptabilit√© : entre 14 et 15h  un jour de semaine de fin d√©cembre). 

Ne pas consid√©rer la charge comme constante mais prendre en compte :

* Les variations journali√®res. Pour une application de gestion avec des utilisateurs travaillant sur des heures de bureau, on observe en g√©n√©ral des pics du double de la charge moyenne dans les p√©riodes 8h-9h, 11h-12h et 14h-15h. Pour une application Internet grand public, ce sera plut√¥t en soir√©e. Encore une fois, se baser sur des mesures d'applications similaires quand c'est possible plut√¥t que sur des estimations.
* Les √©l√©ments de saisonnalit√©. La plupart des m√©tiers en poss√®dent : No√´l pour l'industrie du chocolat, le samedi soir pour les admissions aux urgences, juin pour les centrales de r√©servation de s√©jours etc. La charge peut alors doubler, voire davantage. Il ne faut donc pas n√©gliger cette estimation.

Si le calcul du pic pour un module en bout de cha√Æne de liaison est complexe (par exemple, un service central du SI exposant des donn√©es r√©f√©rentiel et  appel√© par de nombreux modules qui ont chacun leur pic), on tron√ßonnera la journ√©e en intervalles de temps suffisamment fins (une heure par exemple) et on calculera sur chaque intervalle la somme mesur√©e ou estim√©e des appels de chaque appelant (batch ou transactionnel) pour ainsi d√©terminer la sollicitation cumul√©e la plus √©lev√©e.

Si l'application est d√©ploy√©e sur un cloud de type PaaS, la charge sera absorb√©e dynamiquement. Il convient n√©anmoins d'estimer le surco√ªt et de fixer des limites de consommation pour concilier budget et qualit√© de service.
====

.Exemple : estimation volum√©trie dynamique de l'op√©ration REST `GET Detail` de l'application MIEL
|===
|Taux maximal d‚Äôutilisateurs connect√©s en m√™me temps en pic annuel | S1 x F1 x 0.2 = 8K /H  
|Dur√©e moyenne d'une session utilisateur
|15 mins
|Nombre d'appel moyen du service par session
|10
|Charge (Transaction / seconde)
|8K / 4 x 10 / 3600 =  5.5 Tps
|===


[TIP]
====
Pour un service d'infrastructure (comme une instance de base de donn√©es) en bout de cha√Æne et sollicit√© par de nombreux services, il convient d'estimer le nombre de requ√™tes en pic en cumulant les appels de tous les clients et de pr√©ciser le ratio lecture /√©criture quand cette information est pertinente (elle est tr√®s importante pour une base de donn√©es).

Le niveau de d√©tail de l'estimation d√©pend de l'avancement de la conception de l‚Äôapplication et de la fiabilit√© des hypoth√®ses. 

Dans l'exemple plus bas, nous avons d√©j√† une id√©e du nombre de requ√™tes pour chaque op√©ration. Dans d‚Äôautres cas, on devra se contenter d'une estimation tr√®s large sur le nombre de requ√™tes total √† la base de donn√©es et un ratio lecture /√©criture bas√©e sur des abaques d'applications similaires. Inutile de d√©tailler plus √† ce stade.

Enfin, garder en t√™te qu'il s'agit simplement d'estimation √† valider lors de campagnes de performances puis en production. Pr√©voir un ajustement du dimensionnement peu apr√®s la MEP.
====

====
Exemple : la base de donn√©es Oracle BD01 est utilis√©e en lecture par les appels REST `GET DetailArticle` fait depuis l'application end-user et en mise √† jour par les appels POST et PUT sur `DetailArticle` issus du batch d'alimentation B03 la nuit entre 01:00 et 02:00.

.Exemple estimations nombre de requ√™tes SQL en pic vers l'instance BD01 de 01:00 √† 02:00 en d√©cembre
|===
|Taux maximal d‚Äôutilisateurs connect√©s en m√™me temps |0.5%
|Nombre maximal d‚Äôutilisateurs connect√©s concurrents
|5K
|Dur√©e moyenne d'une session utilisateur
|15 mins
|Nombre d'appel moyen du service `GET DetailArticle` par session
|10
|Charge usagers GET DetailArticle (Transaction / seconde)
|(10/15) x 5K / 60 =  55 Tps
|Nombre de requ√™te en lecture et √©criture par appel de service
|2 et 0
|Nombre d'appel journalier du service `POST DetailArticle` depuis le batch B03 
|4K
|Nombre de requ√™tes INSERT et SELECT par appel de service
|3 et 2
|Nombre journalier d'articles modifi√©s par le batch B03 
|10K
|Nombre de requ√™tes SELECT et UPDATE
|1  et 3
|Nombre de SELECT / sec
|55x2 + 2 x 4K/3600 + 1 x 10K/3600=   115 Tps
|Nombre de INSERT / sec
|0 + 3 x 4K/3600 = 3.4 Tps
|Nombre de UPDATE / sec
|0 + 3 x 10K/3600 = 8.3 Tps
|===
====

//üè∑{"id": "c1a8f666-70e1-4acf-9d7a-5e1b06ecb588", "labels": []}
### Exigences de temps de r√©ponse

//üè∑{"id": "24f70acd-5f7c-49b3-bd75-d594e5af8917", "labels": ["niveau_detail::detaill√©", "ihm"]}
#### Temps de R√©ponse des IHM

[TIP]
====
Si les clients acc√®dent au syst√®me en WAN (Internet, VPN, LS ‚Ä¶), pr√©ciser que les exigences de TR sont donn√©es hors transit r√©seau car il est impossible de s‚Äôengager sur la latence et le d√©bit de ce type de client. 

Dans le cas d‚Äôacc√®s LAN, il est pr√©f√©rable d‚Äôint√©grer le temps r√©seau, d‚Äôautant que les outils de test de charge vont d√©j√† le prendre en compte.

Les objectifs de TR sont toujours donn√©s avec une tol√©rance statistique (90e centile par exemple) car la r√©alit√© montre que le TR est tr√®s fluctuant car affect√© par un grand nombre de facteurs.

Inutile de multiplier les types de sollicitations (en fonction de la complexit√© de l‚Äô√©cran par exemple) car ce type de crit√®re n‚Äôa plus grand sens aujourd'hui, particuli√®rement pour une application SPA).
====
====
.Exemple de types de sollicitation¬†:
[cols='3e,1e,1e,1e']
|===
|Type de sollicitation|Bon niveau|Niveau moyen|Niveau insuffisant

|Chargement d‚Äôune page
|< 0,5 s
|< 1 s
|> 2 s

|Op√©ration m√©tier
|< 2 s
|< 4 s
|> 6 s

|√âdition, Export, G√©n√©ration
|< 3 s
|< 6 s
|> 15 s
|===

Exemple d'acceptabilit√© des TR¬†:

Le niveau de respect des exigences de temps de r√©ponse est¬†bon si¬†:

* Au moins 90 % des temps de r√©ponse sont bons.
* Au plus 2% des temps de r√©ponse sont insuffisants.

Acceptable si¬†:

* Au moins 80 % des temps de r√©ponse sont bons.
* Au plus 5 % des temps de r√©ponse sont insuffisants.
      
En dehors de ces valeurs, l‚Äôapplication devra √™tre optimis√©e et repasser en recette puis √™tre soumise √† nouveau aux tests de charge.
====

//üè∑{"id": "88645b89-d407-4107-93b2-48003fd8688a", "labels": ["niveau_detail::detaill√©", "batch"]}
#### Dur√©e d‚Äôex√©cution des batchs

[TIP]
====
Pr√©ciser ici dans quel intervalle de temps les traitements par lot doivent s‚Äôex√©cuter.
====
====
Exemple 1¬†: La fin de l‚Äôex√©cution des batchs √©tant un pr√©-requis √† l‚Äôouverture aux usagers, ces premiers doivent imp√©rativement se terminer avant la fin de la plage batch d√©finie plus haut.
====

====
Exemple 2¬†: le batch mensuel B1 de consolidation des comptes doit s‚Äôex√©cuter en moins de 4 jours.
====

====
Exemple 3¬†: les batchs et les IHM pouvant fonctionner en concurrence, il n‚Äôy a pas de contrainte stricte sur la dur√©e d‚Äôex√©cution des batchs mais pour assurer une optimisation de l‚Äôinfrastructure mat√©rielle, on favorisera la nuit pendant laquelle les sollicitations IHM sont moins nombreuses.
====

//üè∑{"id": "fb740b6a-bd23-4401-a7e0-b01610a01b9b","labels": ["solution"]}
## Dimensionnement cible

[TIP]
====
Nous donnons un dimensionnement final qui doit supporter la volum√©trie statique et dynamique et respecter les exigences.
====

//üè∑{"id": "63214041-3461-4019-a685-fac68fdb4d74", "labels": []}
### Estimation des besoins en ressources par unit√© d√©ployable

[TIP]
====
Fournir ici RAM, disque et CPU par instance d'unit√© d√©ployable (√† affiner apr√®s campagne de performance ou MEP).
====
====
Exemple : 

.Estimation des besoins en ressources par unit√© d√©ployable
[cols="2e,1e,1e,3e,2e"]
|===
| Unit√© d√©ployable | Besoin en (V)CPU par instance| Besoin m√©moire par instance (Mio) |  P√©riodes d'activit√© | Commentaires

| `tomcat-batch_x`
| <n√©gligeable>
| 1024
| Toutes les heures, 24/7/365
| Le serveur d'application reste d√©marr√© m√™me en dehors de l'ex√©cution des jobs

| `spa` 
| <n√©gligeable>
| 50
| 24/6, activit√© principale 8-17h Europe/Paris lun-ven
|Appli Web SPA, s'ex√©cute dans le navigateur

| `bdd-postgresql` 
| 2
| 2024
| 24/7, activit√© principale 8-17h Europe/Paris lun-ven
| Instance PostgreSQL
|===
====

//üè∑{"id": "6e9675d7-5d8c-4cf8-989a-13640cd28ef3", "labels": []}
### Dimensionnement des machines

Voir le link:./vue-infrastructure.adoc#_d√©ploiement_en_production[mod√®le de d√©ploiement].

[TIP]
====

Cette section fournit le dimensionnement final des machines n√©cessaires

* Pour les VM, attention √† v√©rifier qu'un vCPU (Virtual CPU) = 1 c≈ìur physique (et non un thread si hyperthreading activ√©) ;
* Le disque interne concerne le disque n√©cessaire √† l'OS et aux binaires. Pour une machine physique, il s'agit de stockage local (disques locaux SDD, NVMe ou HDD). Pour une VM, il peut s'agir d'un disque local sur la machine physique ex√©cutant la VM ou d'un SAN ;
* Le disque distant concerne du stockage sur une baie de disque (SAN) ;
* Le stockage externe hors SAN concerne du stockage fichier sur un filesyst√®me distribu√© (NFS, CIFS, WebDav, ‚Ä¶) ou un stockage objet (Swift, S3, etc.).
====

.Dimensionnement des machines
[cols='1e,3e,1e,1e,1e,1e,1e']
|===
|Zone | Type de machine | Nb de machines | Nb (V)CPU  | M√©moire (Gio) | Disque interne (Gio) | Disque distant SAN (Gio)

|Zone 01 
|VM serveur applicatif
|3
|2 
|4
|100
|0

|Zone 02
|Machine physique Base de donn√©es
|1
|2
|6
|50
|1024

|===

.Dimensionnement du stockage externe hors SAN
[cols='1e,3e,3e']
|===
|Nature|Taille (Gio)|Type(s) de machine utilisant ce partage

|NFS (montage NAS)
|248
|VM du cluster de calcul

|OpenStack Object Storage ("Swift")
|20
|VM serveur applicatif

|===
